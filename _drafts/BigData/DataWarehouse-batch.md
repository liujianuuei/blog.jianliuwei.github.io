# 数据仓库——离线

本文限定讨论范围为离线数据仓库。

**出现背景**

数据仓库的发展历史可以追溯到上世纪70年代。

**解决问题**

数据仓库的目的是解决"数据分析"的诉求，相比于"数据事务"即增删改查，主要解决数据的"多维查询"。

## 数仓分层

**一般分层原理**

分层的目的是"解耦"和"复用"。

**一般分层实践**

一般分为 ODS、DWD、DWS、ADS 四层，再加 DIM/维表。具体怎么分因公司而异。

**一般各层职能**

ODS 完全保留原始数据。DWD 负责自下而上模型建设，要包含全部"明细数据"，以及指向各个维度的外键值。DWS 负责自上而下模型建设，至少要发生"纵向聚合"或者"横向聚合"。ADS 不需建模按需定制化加工即可。DIM 是对具体分析实体的分析角度。

## 数仓分域

**分域原则**

①按业务过程分；②按业务系统分；③按分析场景分；一般分两级即可。

**分域举例**

经营、风控、分发、Offer、授信、用信、信审、客服、催收、用户。具体比如：

```
————经营
    |————决策
    |————动作
    |————权益
    |————触达
    |————微信
    |————活动
    |————渠道
    |————小满分
    |————开放平台
    |————名单
————风控
    |————贷前
    |————贷后
    |————外部数据
————分发/机构
    |————分发决策
    |————机构额度
    |————机构价格
    |————助贷资金
    |————助贷管理
————Offer
    |————额度
    |————价格
————授信
    |————授信
    |————增信
————交易/用信
    |————交易
    |————OMG
    |————借据-核心
    |————分期-核心
    |————账户-核心
————信审
    |————信审
————客服
    |————客服
————催收
    |————催收
————用户
    |————用户行为
    |————用户设备
    |————用户组件
    |————用户ID
```

**分域实践**

ODS 一般不涉及分域。DWD 按照业务过程或者业务系统从下而上分域。DWS 按照分析场景从上而下分域。ADS 一般没必要分域。DIM 按照业务过程或者业务系统从下而上分域。

注：出于简单考虑，DWS 和 DWD（包括 DIM） 也有时候共用一套分域规则。

## 数仓建模

### 维度建模

对比"关系/ER建模"（也叫范式建模）——指的是对 DW* 进行建模。一般可分为如下几步：

一、确定**业务过程**或业务场景——位于业务全景的哪一块——重要

二、确定**实体**或粒度或主键——明确定义事实表里的**"一行"代表什么**业务含义——非常重要——————\[谁\]

三、确定**维度**也就是关联维度表的维度——可能涉及维度退化——————————————————\[何时何地\]

四、确定业务**事实**信息——按需添加——————————————————————————————\[发生什么\]


### 快照表/快照事实表

**周期快照表**

周期性业务聚集事实，全量加工，_*f。

**累积快照表**

关键业务过程事实，全量加工，_*f。

### 事务表/事务事实表

完整业务变化事实，增量加工，_*d。

### 维表/维度表

配置化、属性、解释类信息，全量加工，_*f。

注：数据源有"流水表"、"状态表"的叫法，流水表是指任何变化都通过新纪录来体现的一类表，状态表也叫覆盖表，是指变化通过修改原记录体现的一类表。配置表一般指的是存放配置信息的表，配置表一般是状态表或覆盖表。记录表也叫事务表一般指的是存放交易事务记录信息的表，记录表或事务表一般是流水表。

## 模型加工

### 离线模型

#### 基本规范

理想情况，应该每一层只依赖上一层；例外但也允许跨层依赖、同层依赖；严格禁止反向依赖。

ODS+DW* 所有字段均为 string 类型，且不允许有 null 值，都转化成空串 ''。

ADS 字段类型按需，一般不涉及小数字段的采用 `bigint`，涉及小数的字段采用 `decimal(38,4)` 或者 `double`。

统一时间格式，比如yyyy-MM-dd HH:mm:ss.SSS。

模型表命名规范：[分层]_[一级主题域]_[二级主题域]_[自定义段]_[dd/df/hd/hf/md/mf]

#### 事务表最佳实践

时间——分区时间vs事务时间/occur_time

#### 快照表最佳实践


